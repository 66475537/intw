<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cn.hsd.rm.flight.mapping.FlightMapper" >
  <resultMap id="BaseResultMap" type="com.cn.hsd.rm.flight.model.Flight" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="ID" property="id" jdbcType="VARCHAR" />
    <result column="FLT_NO" property="fltNo" jdbcType="VARCHAR" />
    <result column="IS_INTERNATIONAL" property="isInternational" jdbcType="VARCHAR" />
    <result column="START_AIRPORT" property="startAirport" jdbcType="VARCHAR" />
    <result column="END_AIRPORT" property="endAirport" jdbcType="VARCHAR" />
    <result column="START_TIME" property="startTime" jdbcType="VARCHAR" />
    <result column="REAL_START_TIME" property="realStartTime" jdbcType="VARCHAR" />
    <result column="DEPARTURE_TIME" property="departureTime" jdbcType="VARCHAR" />
    <result column="REAL_END_TIME" property="realEndTime" jdbcType="VARCHAR" />
    <result column="END_TIME" property="endTime" jdbcType="VARCHAR" />
    <result column="ARRIVAL_TIME" property="arrivalTime" jdbcType="VARCHAR" />
    <result column="DISPATCH_DATE" property="dispatchDate" jdbcType="VARCHAR" />
    <result column="IS_APPROVE" property="isApprove" jdbcType="VARCHAR" />
    <result column="IS_BAK" property="isBak" jdbcType="VARCHAR" />
    <result column="OPEN_DOOR_DATE" property="openDoorDate" jdbcType="VARCHAR" />
    <result column="CLOSE_DOOR_DATE" property="closeDoorDate" jdbcType="VARCHAR" />
    <result column="CREATE_TIME" property="createTime" jdbcType="VARCHAR" />
    <result column="IS_CHANGE" property="isChange" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    ID, FLT_NO, IS_INTERNATIONAL, START_AIRPORT, END_AIRPORT, START_TIME, REAL_START_TIME, 
    DEPARTURE_TIME, REAL_END_TIME, END_TIME, ARRIVAL_TIME, DISPATCH_DATE, IS_APPROVE, 
    IS_BAK, OPEN_DOOR_DATE, CLOSE_DOOR_DATE, CREATE_TIME, IS_CHANGE
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from flight
    where ID = #{id,jdbcType=VARCHAR}
  </select>
  <sql id="getConditionIndex">
    <where>
      <if test="dateValueStart != null and dateValueStart != ''">
        AND f.START_TIME &gt;= #{dateValueStart}
      </if>
      <if test="dateValueEnd != null and dateValueEnd != ''">
        AND f.START_TIME &lt;= #{dateValueEnd}
      </if>
    </where>
  </sql>
  <!-- 首页航班风险结果列表 -->
  <select id="getFlightRiskResultList" parameterType="java.util.Map" resultType="java.util.Map">
    SELECT
      f.FLT_NO,
      (CASE f.IS_INTERNATIONAL WHEN '1' THEN '是' ELSE '否' END) AS IS_INTERNATIONAL,
      f.START_AIRPORT,
      f.START_TIME,
      f.END_AIRPORT,
      f.END_TIME,
      brd.RISK_GRADE
    FROM FLIGHT f
    INNER JOIN BI_RESULT_DATA brd ON f.FLT_NO = brd.FLT_NO
    <include refid="getConditionIndex"/>
    ORDER BY brd.CREATE_TIME DESC, brd.FLT_NO ASC
  </select>
  <!-- 首页航班风险预警数量 -->
  <select id="getFlightRiskInfoCountIndex" parameterType="java.util.Map" resultType="java.util.Map">
    SELECT
      COUNT(DISTINCT f.FLT_NO) AS CURRENT_FLIGHT_TOTAL,
      IFNULL(SUM(CASE brd.RISK_GRADE WHEN '低' THEN 1 ELSE 0 END), 0) AS LOW_TOTAL,
      IFNULL(SUM(CASE brd.RISK_GRADE WHEN '中' THEN 1 ELSE 0 END), 0) AS MIDDLE_TOTAL,
      IFNULL(SUM(CASE brd.RISK_GRADE WHEN '高' THEN 1 ELSE 0 END), 0) AS HIGH_TOTAL
    FROM FLIGHT f
    INNER JOIN BI_RESULT_DATA brd ON f.FLT_NO = brd.FLT_NO
    <include refid="getConditionIndex"/>
    ORDER BY brd.CREATE_TIME DESC, brd.FLT_NO ASC
  </select>
  <sql id="getFlightRiskResultDetailsCondition">
    <where>
      <if test="currentDate != null and currentDate != ''">
        AND LEFT(f.START_TIME, 10) = #{currentDate}
      </if>
    </where>
  </sql>
  <!-- 查询航班风险评估列表 -->
  <select id="getFlightRiskResultDetailsList" parameterType="java.util.Map" resultType="java.util.Map">
    SELECT
      f.FLT_NO,
      (CASE f.IS_INTERNATIONAL WHEN 1 THEN '是' ELSE '否' END) AS IS_INTERNATIONAL,
      LEFT(f.START_TIME, 10) AS START_TIME,
      CONCAT(f.START_AIRPORT, '-', f.END_AIRPORT) AS AIRPORT_START_END,
      CONCAT(SUBSTR(f.START_TIME, 12, 5), '-', SUBSTR(f.END_TIME, 12, 5)) AS TIME_START_END,
      (CASE brd.RISK_GRADE WHEN '低' THEN '是' ELSE '否' END) AS IS_NORMAL,
      brf.NAME,
      brd.RESULT
    FROM FLIGHT f
    INNER JOIN BI_RESULT_DATA brd ON f.FLT_NO = brd.FLT_NO
    INNER JOIN BI_RISK_FACTORS brf ON brd.RISK_ID = brf.RISK_ID
    INNER JOIN BI_RISK_FACTORS_LEVEL brfl ON brf.RISK_ID = brfl.RISK_ID
    <include refid="getFlightRiskResultDetailsCondition"/>
  </select>
  <!-- 查询机组成员 -->
  <select id="getAirMembers" parameterType="java.util.Map" resultType="java.lang.String">
    SELECT
    GROUP_CONCAT(DISTINCT p.NAME separator '-') AS AIR_MEMBER
    FROM FLIGHT f
    INNER JOIN FLIGHT_PILOT fp ON fp.FLT_ID = f.ID
    INNER join PILOTS p ON p.PILOTS_ID = fp.PILOT_ID
    WHERE f.FLT_NO = #{FLT_NO}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from flight
    where ID = #{id,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.cn.hsd.rm.flight.model.Flight" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into flight (ID, FLT_NO, IS_INTERNATIONAL, 
      START_AIRPORT, END_AIRPORT, START_TIME, 
      REAL_START_TIME, DEPARTURE_TIME, REAL_END_TIME, 
      END_TIME, ARRIVAL_TIME, DISPATCH_DATE, 
      IS_APPROVE, IS_BAK, OPEN_DOOR_DATE, 
      CLOSE_DOOR_DATE, CREATE_TIME, IS_CHANGE
      )
    values (#{id,jdbcType=VARCHAR}, #{fltNo,jdbcType=VARCHAR}, #{isInternational,jdbcType=VARCHAR}, 
      #{startAirport,jdbcType=VARCHAR}, #{endAirport,jdbcType=VARCHAR}, #{startTime,jdbcType=VARCHAR}, 
      #{realStartTime,jdbcType=VARCHAR}, #{departureTime,jdbcType=VARCHAR}, #{realEndTime,jdbcType=VARCHAR}, 
      #{endTime,jdbcType=VARCHAR}, #{arrivalTime,jdbcType=VARCHAR}, #{dispatchDate,jdbcType=VARCHAR}, 
      #{isApprove,jdbcType=VARCHAR}, #{isBak,jdbcType=VARCHAR}, #{openDoorDate,jdbcType=VARCHAR}, 
      #{closeDoorDate,jdbcType=VARCHAR}, #{createTime,jdbcType=VARCHAR}, #{isChange,jdbcType=VARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.cn.hsd.rm.flight.model.Flight" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into flight
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        ID,
      </if>
      <if test="fltNo != null" >
        FLT_NO,
      </if>
      <if test="isInternational != null" >
        IS_INTERNATIONAL,
      </if>
      <if test="startAirport != null" >
        START_AIRPORT,
      </if>
      <if test="endAirport != null" >
        END_AIRPORT,
      </if>
      <if test="startTime != null" >
        START_TIME,
      </if>
      <if test="realStartTime != null" >
        REAL_START_TIME,
      </if>
      <if test="departureTime != null" >
        DEPARTURE_TIME,
      </if>
      <if test="realEndTime != null" >
        REAL_END_TIME,
      </if>
      <if test="endTime != null" >
        END_TIME,
      </if>
      <if test="arrivalTime != null" >
        ARRIVAL_TIME,
      </if>
      <if test="dispatchDate != null" >
        DISPATCH_DATE,
      </if>
      <if test="isApprove != null" >
        IS_APPROVE,
      </if>
      <if test="isBak != null" >
        IS_BAK,
      </if>
      <if test="openDoorDate != null" >
        OPEN_DOOR_DATE,
      </if>
      <if test="closeDoorDate != null" >
        CLOSE_DOOR_DATE,
      </if>
      <if test="createTime != null" >
        CREATE_TIME,
      </if>
      <if test="isChange != null" >
        IS_CHANGE,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="fltNo != null" >
        #{fltNo,jdbcType=VARCHAR},
      </if>
      <if test="isInternational != null" >
        #{isInternational,jdbcType=VARCHAR},
      </if>
      <if test="startAirport != null" >
        #{startAirport,jdbcType=VARCHAR},
      </if>
      <if test="endAirport != null" >
        #{endAirport,jdbcType=VARCHAR},
      </if>
      <if test="startTime != null" >
        #{startTime,jdbcType=VARCHAR},
      </if>
      <if test="realStartTime != null" >
        #{realStartTime,jdbcType=VARCHAR},
      </if>
      <if test="departureTime != null" >
        #{departureTime,jdbcType=VARCHAR},
      </if>
      <if test="realEndTime != null" >
        #{realEndTime,jdbcType=VARCHAR},
      </if>
      <if test="endTime != null" >
        #{endTime,jdbcType=VARCHAR},
      </if>
      <if test="arrivalTime != null" >
        #{arrivalTime,jdbcType=VARCHAR},
      </if>
      <if test="dispatchDate != null" >
        #{dispatchDate,jdbcType=VARCHAR},
      </if>
      <if test="isApprove != null" >
        #{isApprove,jdbcType=VARCHAR},
      </if>
      <if test="isBak != null" >
        #{isBak,jdbcType=VARCHAR},
      </if>
      <if test="openDoorDate != null" >
        #{openDoorDate,jdbcType=VARCHAR},
      </if>
      <if test="closeDoorDate != null" >
        #{closeDoorDate,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=VARCHAR},
      </if>
      <if test="isChange != null" >
        #{isChange,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.cn.hsd.rm.flight.model.Flight" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update flight
    <set >
      <if test="fltNo != null" >
        FLT_NO = #{fltNo,jdbcType=VARCHAR},
      </if>
      <if test="isInternational != null" >
        IS_INTERNATIONAL = #{isInternational,jdbcType=VARCHAR},
      </if>
      <if test="startAirport != null" >
        START_AIRPORT = #{startAirport,jdbcType=VARCHAR},
      </if>
      <if test="endAirport != null" >
        END_AIRPORT = #{endAirport,jdbcType=VARCHAR},
      </if>
      <if test="startTime != null" >
        START_TIME = #{startTime,jdbcType=VARCHAR},
      </if>
      <if test="realStartTime != null" >
        REAL_START_TIME = #{realStartTime,jdbcType=VARCHAR},
      </if>
      <if test="departureTime != null" >
        DEPARTURE_TIME = #{departureTime,jdbcType=VARCHAR},
      </if>
      <if test="realEndTime != null" >
        REAL_END_TIME = #{realEndTime,jdbcType=VARCHAR},
      </if>
      <if test="endTime != null" >
        END_TIME = #{endTime,jdbcType=VARCHAR},
      </if>
      <if test="arrivalTime != null" >
        ARRIVAL_TIME = #{arrivalTime,jdbcType=VARCHAR},
      </if>
      <if test="dispatchDate != null" >
        DISPATCH_DATE = #{dispatchDate,jdbcType=VARCHAR},
      </if>
      <if test="isApprove != null" >
        IS_APPROVE = #{isApprove,jdbcType=VARCHAR},
      </if>
      <if test="isBak != null" >
        IS_BAK = #{isBak,jdbcType=VARCHAR},
      </if>
      <if test="openDoorDate != null" >
        OPEN_DOOR_DATE = #{openDoorDate,jdbcType=VARCHAR},
      </if>
      <if test="closeDoorDate != null" >
        CLOSE_DOOR_DATE = #{closeDoorDate,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        CREATE_TIME = #{createTime,jdbcType=VARCHAR},
      </if>
      <if test="isChange != null" >
        IS_CHANGE = #{isChange,jdbcType=VARCHAR},
      </if>
    </set>
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.cn.hsd.rm.flight.model.Flight" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update flight
    set FLT_NO = #{fltNo,jdbcType=VARCHAR},
      IS_INTERNATIONAL = #{isInternational,jdbcType=VARCHAR},
      START_AIRPORT = #{startAirport,jdbcType=VARCHAR},
      END_AIRPORT = #{endAirport,jdbcType=VARCHAR},
      START_TIME = #{startTime,jdbcType=VARCHAR},
      REAL_START_TIME = #{realStartTime,jdbcType=VARCHAR},
      DEPARTURE_TIME = #{departureTime,jdbcType=VARCHAR},
      REAL_END_TIME = #{realEndTime,jdbcType=VARCHAR},
      END_TIME = #{endTime,jdbcType=VARCHAR},
      ARRIVAL_TIME = #{arrivalTime,jdbcType=VARCHAR},
      DISPATCH_DATE = #{dispatchDate,jdbcType=VARCHAR},
      IS_APPROVE = #{isApprove,jdbcType=VARCHAR},
      IS_BAK = #{isBak,jdbcType=VARCHAR},
      OPEN_DOOR_DATE = #{openDoorDate,jdbcType=VARCHAR},
      CLOSE_DOOR_DATE = #{closeDoorDate,jdbcType=VARCHAR},
      CREATE_TIME = #{createTime,jdbcType=VARCHAR},
      IS_CHANGE = #{isChange,jdbcType=VARCHAR}
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  
  
  <select id="queryFlightNo" resultMap="BaseResultMap">
    select FLT_NO,ID from FLIGHT  group by FLT_NO,ID
  </select>



    <select id="queryPilotsInThisFlight" resultType="com.cn.hsd.rm.flight.model.Pilots" parameterType="string">
        select p.PILOTS_ID pilotsId,NAME name,TECHNICAL_GRADE technicalGrade
        from PILOTS p where p.PILOTS_ID in ( SELECT fp.PILOT_ID from FLIGHT_PILOT fp
        where fp.FLT_ID=#{flightId})
    </select>
  <select id="queryPilotsNotInThisFlight" resultType="com.cn.hsd.rm.flight.model.Pilots" parameterType="string">
        select p.PILOTS_ID pilotsId,NAME name,TECHNICAL_GRADE technicalGrade
        from PILOTS p where p.PILOTS_ID NOT IN ( SELECT fp.PILOT_ID from FLIGHT_PILOT fp
        where fp.FLT_ID=#{flightId})
  </select>
</mapper>